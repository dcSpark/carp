"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8316],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(t),m=r,k=u["".concat(s,".").concat(m)]||u[m]||d[m]||o;return t?a.createElement(k,i(i({ref:n},p),{},{components:t})):a.createElement(k,i({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},8734:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=t(7462),r=(t(7294),t(3905));const o={sidebar_position:7},i="Starting Carp in container",l={unversionedId:"indexer/docker",id:"indexer/docker",title:"Starting Carp in container",description:"Carp can be run using docker-compose. It creates 4 (+1 optional) services:",source:"@site/docs/indexer/docker.md",sourceDirName:"indexer",slug:"/indexer/docker",permalink:"/carp/docs/indexer/docker",draft:!1,editUrl:"https://github.com/dcSpark/carp/docs/indexer/docker.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"SQL Format",permalink:"/carp/docs/indexer/sql"},next:{title:"Tasks",permalink:"/carp/docs/indexer/Tasks/"}},s={},c=[{value:"Backup service",id:"backup-service",level:2},{value:"Environment setup",id:"environment-setup",level:2},{value:"<code>.pgpass</code> location",id:"pgpass-location",level:2},{value:"Carp configuration",id:"carp-configuration",level:2},{value:"Sink configuration changes",id:"sink-configuration-changes",level:3},{value:"Source configuration changes",id:"source-configuration-changes",level:3},{value:"Oura",id:"oura",level:4},{value:"Cardano_net",id:"cardano_net",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2}],p={toc:c};function d(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"starting-carp-in-container"},"Starting Carp in container"),(0,r.kt)("p",null,"Carp can be run using ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose"),". It creates 4 (+1 optional) services:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"postgres - container running postgres database"),(0,r.kt)("li",{parentName:"ul"},"cardano-node - container running cardano-node"),(0,r.kt)("li",{parentName:"ul"},"carp - container build locally with carp"),(0,r.kt)("li",{parentName:"ul"},"carp_web - webserver for carp")),(0,r.kt)("p",null,"To run docker deployment you will need to configure .env file, carp's config. We've prepared the necessary configs to run the whole deployment for mainnet. You can run with other networks using the instructions below. "),(0,r.kt)("p",null,"Run the deployment with the following command from ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment")," folder:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose --env-file config/indexer/docker.env up -d\n")),(0,r.kt)("p",null,"Setup assumes ports 3000, 3001 and 5432 are available."),(0,r.kt)("h2",{id:"backup-service"},"Backup service"),(0,r.kt)("p",null,"There is an optional container that can perform back of the database to a s3 bucket.\nIt checks every hour the cardano-node tip epoch and if it changes, an SQL backup is being generated.\nBy default, the backup service is commented out. At the moment only mainnet and testnet are supported by backuper."),(0,r.kt)("p",null,"Backup service will upload file to path:\n",(0,r.kt)("inlineCode",{parentName:"p"},"s3://${S3_BUCKET}/${S3_FOLDER}/${NETWORK}/")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WARNING:"),"\nStarting Carp with backup service from scratch will create a dozens of backups until cardano-node fully synchronizes."),(0,r.kt)("h2",{id:"environment-setup"},"Environment setup"),(0,r.kt)("p",null,"Some environment variables must be set up to ensure successful running of all containers. We've prepared an example .env file: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/dcSpark/carp/blob/main/deployment/config/indexer/docker.env"},"docker.env"),". It contains mandatory variables already:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dotenv"},"# network can be mainnet/preview/preprod/testnet\n# this parameter is utilized by migration service and docker-compose\nNETWORK=mainnet\n\n# can be cardano_node_docker.yml or oura_docker.yml or \n# any custom filename located in deployment/config/indexer folder \n# alternative to CARP_CONFIG env variable\nCONFIG_FILE=cardano_node_docker.yml\n\nCARP_VERSION=3.0.0\n\n# these credentials are utilized by postgres, carp and carp_web services\n# host should be container name or static ip\nPOSTGRES_HOST=postgres\nPOSTGRES_PORT=5432\nPOSTGRES_DB=carp_mainnet\nPGUSER=carp\nPGPASSWORD=1234\nPGPASSFILE=\"$(realpath secrets/.pgpass)\"\n\n# note: PGPASSWORD isn't required to run carp\n# since it will be parsed from the PGPASSFILE instead\n# as this command will gracefully fallback to PGPASSFILE if no password is specified\n# However, some dev tools like pgtyped & zapatos don't support .pgpass files\nDATABASE_URL=postgresql://${PGUSER}:${PGPASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}\n")),(0,r.kt)("p",null,"Please set ",(0,r.kt)("inlineCode",{parentName:"p"},"NETWORK"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"CONFIG_FILE")," and postgres variables carefully. ",(0,r.kt)("inlineCode",{parentName:"p"},"CONFIG_FILE")," should be located in ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment/config/indexer")," folder. You can use ",(0,r.kt)("inlineCode",{parentName:"p"},"CARP_CONFIG")," env variable instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"CONFIG_FILE")," if you want to use just env variables for configuration."),(0,r.kt)("p",null,"You can also add non-mandatory variables that are useful for backuper:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# optional content for backup service\nS3_BUCKET=<name of bucket to store backups>\nS3_FOLDER=<name of folder inside s3 bucket. I recommend host name>\nAWS_ACCESS_KEY_ID=<Access key for given s3 bucket with creation permissions>\nAWS_SECRET_ACCESS_KEY=<Secret for given account>\n")),(0,r.kt)("h2",{id:"pgpass-location"},(0,r.kt)("inlineCode",{parentName:"h2"},".pgpass")," location"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},".pgpass")," file should be stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment/config/secrets/<NETWORK>/.pgpass"),"."),(0,r.kt)("h2",{id:"carp-configuration"},"Carp configuration"),(0,r.kt)("p",null,"We mentioned config files above, they should be stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment/config/indexer")," folder, and you should set ",(0,r.kt)("inlineCode",{parentName:"p"},"CONFIG_FILE")," env variable with the config name. Alternatively you can set ",(0,r.kt)("inlineCode",{parentName:"p"},"CARP_CONFIG")," env variable and not use the configuration file"),(0,r.kt)("p",null,"The difference from non-docker configuration is in the networking mainly."),(0,r.kt)("h3",{id:"sink-configuration-changes"},"Sink configuration changes"),(0,r.kt)("p",null,"For sink you should set host to postgres container name from docker-compose: ",(0,r.kt)("inlineCode",{parentName:"p"},"postgres"),". Other logic is the same. This change is mandatory, since docker network resolution uses container names (ips are non-static in general case and localhost won't work either)"),(0,r.kt)("h3",{id:"source-configuration-changes"},"Source configuration changes"),(0,r.kt)("h4",{id:"oura"},"Oura"),(0,r.kt)("p",null,"For oura source you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"Unix")," socket:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'source:\n  type: oura\n  socket: "/app/node-ipc/node.socket"\n  bearer: Unix\n')),(0,r.kt)("p",null,"Alternatively you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"Tcp")," as well:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'source:\n  type: oura\n  socket: "172.20.0.4:3001"\n  bearer: Tcp\n')),(0,r.kt)("h4",{id:"cardano_net"},"Cardano_net"),(0,r.kt)("p",null,"For ",(0,r.kt)("inlineCode",{parentName:"p"},"cardano_net")," you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"Tcp")," only:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"source:\n  type: cardano_net\n  relay:\n    - 172.20.0.4\n    - 3001\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"cardano-node")," container has static ip ",(0,r.kt)("inlineCode",{parentName:"p"},"172.20.0.4")," in docker-compose."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WARNING"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"cardano_net")," can't resolve docker names itself, that's why static ip is assigned."),(0,r.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,r.kt)("p",null,"Docker deployment shares with local filesystem in paths:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"# cardano-node container\ndeployment/<NETWORK>/node-ipc\ndeployment/<NETWORK>/node-db\n\n# postgres container\ndeployment/<NETWORK>/postgres-data\n\n# carp container\ndeployment/<NETWORK>/node-ipc # to read unix socket\ndeployment/config/indexer/ # to get config for carp\n")),(0,r.kt)("p",null,"If at any point you broke the consistency (by running multiple deployments with access to the same folders / running incompatible software versions), you can remove non-config folders from above (but all progress will be ",(0,r.kt)("strong",{parentName:"p"},"lost"),")."),(0,r.kt)("p",null,"Don't hesitate to submit issues to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/dcSpark/carp/issues"},"carp repository")," as well."))}d.isMDXComponent=!0}}]);